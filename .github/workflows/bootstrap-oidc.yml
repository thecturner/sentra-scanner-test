name: Bootstrap OIDC

on:
  push:
    paths:
      - 'infra/gha-oidc/**'
      - '.github/workflows/bootstrap-oidc.yml'
  workflow_dispatch: {}

concurrency:
  group: bootstrap-oidc
  cancel-in-progress: false

jobs:
  bootstrap_oidc:
    name: Create OIDC provider/role if missing, then disable this workflow
    runs-on: ubuntu-latest

    # We need to disable this workflow via the API
    permissions:
      actions: write
      contents: read

    env:
      AWS_REGION: us-east-1
      # Hardcoded default role name. Set repo variable OIDC_ROLE_NAME to override if you want.
      OIDC_ROLE_NAME: ${{ vars.OIDC_ROLE_NAME || 'gha-oidc-sentra-scanner' }}
      WORKFLOW_FILE: bootstrap-oidc.yml

    steps:
      - name: Check out
        uses: actions/checkout@v4

      - name: Guard. require temporary bootstrap secrets or exit quietly
        id: guard
        shell: bash
        run: |
          if [[ -z "${{ secrets.BOOTSTRAP_AWS_ACCESS_KEY_ID }}" || -z "${{ secrets.BOOTSTRAP_AWS_SECRET_ACCESS_KEY }}" ]]; then
            echo "Bootstrap secrets are not set. Skipping bootstrap. This is expected after the first run."
            echo "no_creds=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Configure AWS credentials (temp access key)
        if: steps.guard.outputs.no_creds != 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.BOOTSTRAP_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.BOOTSTRAP_AWS_SECRET_ACCESS_KEY }}
          aws-session-token:     ${{ secrets.BOOTSTRAP_AWS_SESSION_TOKEN }}
          aws-region:            ${{ env.AWS_REGION }}

      - name: Ensure AWS CLI present
        if: steps.guard.outputs.no_creds != 'true'
        run: aws --version || { sudo apt-get update && sudo apt-get install -y awscli; }

      - name: Check for OIDC provider and role
        if: steps.guard.outputs.no_creds != 'true'
        id: check
        shell: bash
        run: |
          set -euo pipefail
          ROLE_NAME="${{ env.OIDC_ROLE_NAME }}"

          # Check provider
          if aws iam list-open-id-connect-providers --query 'OpenIDConnectProviderList[].Arn' --output text | grep -q 'token.actions.githubusercontent.com'; then
            echo "provider_exists=true" >> "$GITHUB_OUTPUT"
            echo "OIDC provider exists"
          else
            echo "provider_exists=false" >> "$GITHUB_OUTPUT"
            echo "OIDC provider missing"
          fi

          # Check role
          if aws iam get-role --role-name "$ROLE_NAME" >/dev/null 2>&1; then
            echo "role_exists=true" >> "$GITHUB_OUTPUT"
            echo "OIDC role '$ROLE_NAME' exists"
          else
            echo "role_exists=false" >> "$GITHUB_OUTPUT"
            echo "OIDC role '$ROLE_NAME' missing"
          fi

      - name: Setup Terraform
        if: steps.guard.outputs.no_creds != 'true' && (steps.check.outputs.provider_exists != 'true' || steps.check.outputs.role_exists != 'true')
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      - name: Terraform init
        if: steps.guard.outputs.no_creds != 'true' && (steps.check.outputs.provider_exists != 'true' || steps.check.outputs.role_exists != 'true')
        run: terraform -chdir=infra/gha-oidc init -input=false

      - name: Terraform apply infra/gha-oidc
        if: steps.guard.outputs.no_creds != 'true' && (steps.check.outputs.provider_exists != 'true' || steps.check.outputs.role_exists != 'true')
        id: apply
        run: |
          set -euo pipefail
          terraform -chdir=infra/gha-oidc apply -auto-approve \
            -var='create_results_kms=false' \
            -var='results_kms_arn=""'

      # Disable this workflow if:
      # - we detected both provider and role already existed, or
      # - apply just ran successfully and created what's missing
      - name: Disable this workflow
        if: steps.guard.outputs.no_creds != 'true' && (
              (steps.check.outputs.provider_exists == 'true' && steps.check.outputs.role_exists == 'true') ||
              always()
            )
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const workflow_id = process.env.WORKFLOW_FILE; // file name works here
            core.info(`Disabling workflow ${workflow_id} for ${owner}/${repo}...`);
            try {
              await github.rest.actions.disableWorkflow({ owner, repo, workflow_id });
              core.info('Disabled. Re-enable from the Actions tab if needed.');
            } catch (e) {
              core.warning(`Could not disable workflow: ${e.message}`);
            }
